cache:
    key: "GLOBAL_CACHE"
    paths:
      - cache/
      - yandex-cloud/

job1:
  script:
    - curl https://raw.githubusercontent.com/Jokero/yandex-cloud-cli-install-for-ci/master/install.sh | bash
  rules:
    - exists: 
      - yandex-cloud/bin/yc
      when: never
    - when: always

job2:
  script:
    - ssh-keygen -b 2048 -t rsa -f cache/sshkey -q -N ""
  rules:
    - exists:
      - cache/sshkey
      when: never
    - when: always

job3:
  script:
    - export PATH=$PATH:~/yandex-cloud/bin
    - yc -v
    - yc config set compute-default-zone ru-central1-b #не используется
    - yc --token $YC_TOKEN --cloud-id $YC_CLOUD_ID --folder-id $YC_FOLDER_ID compute instance list
    - >
     yc 
     --token $YC_TOKEN --cloud-id $YC_CLOUD_ID --folder-id $YC_FOLDER_ID 
     compute instance create 
     --name first-instance 
     --zone ru-central1-a 
     --public-ip 
     --create-boot-disk size=20G,image-folder-id=standard-images,image-family=centos-8 
     --preemptible 
     --core-fraction 20 
     --memory 6 
     --ssh-key sshkey.pub 
    - >
     yc 
     --token $YC_TOKEN --cloud-id $YC_CLOUD_ID --folder-id $YC_FOLDER_ID 
     compute instance list
    - >
     yc 
     --token $YC_TOKEN --cloud-id $YC_CLOUD_ID --folder-id $YC_FOLDER_ID 
     compute instance get first-instance
  artifacts:
    paths:
      - cache/sshkey
      - cache/sshkey.pub
    expire_in: 1 week
